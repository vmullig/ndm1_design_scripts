<ROSETTASCRIPTS>
    <SCOREFXNS>
        <ScoreFunction name="r15" weights="ref2015.wts" />
        <ScoreFunction name="r15_relax" weights="ref2015_cst.wts" >
            <Reweight scoretype="chainbreak" weight="20.0" />
        </ScoreFunction>
        <ScoreFunction name="r15_design" weights="ref2015_cst.wts" >
            <Reweight scoretype="buried_unsatisfied_penalty" weight="30.0" />
            <Reweight scoretype="hbnet" weight="1.0" />
            <Reweight scoretype="voids_penalty" weight="1.0" />
            <Reweight scoretype="aspartimide_penalty" weight="2.0" />
            <Reweight scoretype="aa_composition" weight="1.0" />
            <Reweight scoretype="chainbreak" weight="20.0" />
            <Reweight scoretype="hbond_sr_bb" weight="10.0" />
            <Reweight scoretype="hbond_lr_bb" weight="10.0" />
            <Set voids_penalty_energy_containing_cones_cutoff="4" />
            <Set voids_penalty_energy_cone_distance_cutoff="7.0" />
            <Set buried_unsatisfied_penalty_burial_threshold="1.5" />
            <Set buried_unsatisfied_penalty_cone_dist_midpoint="7.0" />
            <Set buried_unsatisfied_penalty_cone_angle_exponent="2.0" />
            <Set buried_unsatisfied_penalty_cone_angle_shift_factor="0.35" />
        </ScoreFunction>
        <ScoreFunction name="r15_design2" weights="ref2015_cst.wts" >
            <Reweight scoretype="buried_unsatisfied_penalty" weight="10.0" />
            <Reweight scoretype="hbnet" weight="0.5" />
            <Reweight scoretype="voids_penalty" weight="0.1" />
            <Reweight scoretype="aspartimide_penalty" weight="2.0" />
            <Reweight scoretype="aa_composition" weight="1.0" />
            <Reweight scoretype="chainbreak" weight="20.0" />
            <Set voids_penalty_energy_containing_cones_cutoff="4" />
            <Set voids_penalty_energy_cone_distance_cutoff="7.0" />
            <Set buried_unsatisfied_penalty_burial_threshold="1.5" />
            <Set buried_unsatisfied_penalty_cone_dist_midpoint="7.0" />
            <Set buried_unsatisfied_penalty_cone_angle_exponent="2.0" />
            <Set buried_unsatisfied_penalty_cone_angle_shift_factor="0.35" />
        </ScoreFunction>
    </SCOREFXNS>
    <RESIDUE_SELECTORS>
        <Index name="select_pep_start" resnums="230" />
        <Index name="select_pep_end" resnums="237" />
        <Index name="select_loop_cutpoint_upper" resnums="29" />
        <Index name="select_loop_cutpoint_lower" resnums="28" />
        <Index name="select_pep" resnums="230-237" />
        <Not name="select_not_pep" selector="select_pep" />
        <Phi name="select_pos_phi" select_positive_phi="true" />
        <Not name="select_neg_phi" selector="select_pos_phi" />
        <And name="select_pos_phi_and_pep" selectors="select_pos_phi,select_pep" />
        <And name="select_neg_phi_and_pep" selectors="select_neg_phi,select_pep" />
        <Index name="select_ndm1_hingeloop" resnums="23-33" />
        <Or name="select_movable_loops" selectors="select_ndm1_hingeloop,select_pep" />
        <Neighborhood name="select_pep_and_vicinity" include_focus_in_subset="true" selector="select_movable_loops" distance="8.0" />
        <Not name="select_not_pep_or_vicinity" selector="select_pep_and_vicinity" />
        <Index name="select_anchor_res" resnums="234" />
        <Index name="select_preserved_pro" resnums="235" />
    </RESIDUE_SELECTORS>
    <PACKER_PALETTES>
        <CustomBaseTypePackerPalette name="packer_palette" additional_residue_types="DALA,DASP,DGLU,DPHE,DHIS,DILE,DLYS,DLEU,DASN,DPRO,DGLN,DARG,DSER,DTHR,DVAL,DTRP,DTYR,NLU,NVL,DNLU,DNVL,ORN,DAB,DPP,DORN,DDAB,DDPP,AIB,B12,DB12,B96,DB96,BB8,DBB8,A43,DA43,A78,DA78,A80,DA80,B36,DB36" />
    </PACKER_PALETTES>
    <TASKOPERATIONS>
        <OperateOnResidueSubset name="only_repack_pro235" selector="select_preserved_pro" >
            <RestrictToRepackingRLT />
        </OperateOnResidueSubset>
        <InitializeFromCommandline name="init_from_commandline" />
        <ExtraRotamersGeneric name="extrarot" ex1="true" ex2="false" />
        <ExtraRotamersGeneric name="extrarot2" ex1="true" ex2="true" />
        <OperateOnResidueSubset name="only_design_pep" selector="select_not_pep" >
            <RestrictToRepackingRLT />
        </OperateOnResidueSubset>
        <OperateOnResidueSubset name="only_pack_near_pep" selector="select_not_pep_or_vicinity" >  
            <PreventRepackingRLT />
        </OperateOnResidueSubset>
        <ProhibitSpecifiedBaseResidueTypes name="no_cys_gly_met" base_types="GLY,CYS,MET" selector="select_pep" />
        <ProhibitResidueProperties name="only_l_at_neg_phi" selector="select_neg_phi_and_pep" properties="D_AA" />
        <ProhibitResidueProperties name="only_d_at_pos_phi" selector="select_pos_phi_and_pep" properties="L_AA" />
        <OperateOnResidueSubset name="no_pack_anchor" selector="select_anchor_res">
            <PreventRepackingRLT />
        </OperateOnResidueSubset>
        <RestrictToRepacking name="restrict_to_repacking" />
    </TASKOPERATIONS>
    <MOVE_MAP_FACTORIES>
        <MoveMapFactory name="mm_factory" bb="false" chi="false" jumps="false" >
            <Backbone residue_selector="select_movable_loops" />
            <Chi residue_selector="select_pep_and_vicinity" />
        </MoveMapFactory>
    </MOVE_MAP_FACTORIES>
    <SIMPLE_METRICS>
        <SequenceMetric name="capture_sequence" output_mode="basename" residue_selector="select_pep" />
    </SIMPLE_METRICS>
    <MOVERS>
        <FastRelax name="frelax_for_filter" repeats="3" scorefxn="r15_relax" movemap_factory="mm_factory" task_operations="only_repack_pro235,extrarot2,restrict_to_repacking,only_pack_near_pep" relaxscript="MonomerRelax2019" />
    </MOVERS>
    <FILTERS>
        <ShapeComplementarity name="shape_complementarity" min_sc="0.4" min_interface="250" write_int_area="true" residue_selector1="select_pep" residue_selector2="select_not_pep" />
        <Ddg name="ddg" jump="2" confidence="1" threshold="-10.0" scorefxn="r15" repeats="15" repack="true" repack_unbound="false" relax_unbound="true" repack_bound="false" relax_bound="true" relax_mover="frelax_for_filter" translate_by="10000" extreme_value_removal="true" />
    </FILTERS>
    <MOVERS>
        <!-- For testing only -->
        <MutateResidue name="mut_to_ala" target="237" new_res="ALA" />

        <!-- Set up cyclization -->
        <DeclareBond name="cyclization_bond" res1="237" res2="230" atom1="C" atom2="N" />
        <DeclareBond name="loop_bond" res1="28" res2="29" atom1="C" atom2="N" />

        <!-- Add outpoint variants -->
                <ModifyVariantType name="add_cutpoint_upper_pep" add_type="CUTPOINT_UPPER" residue_selector="select_pep_start" />
                <ModifyVariantType name="add_cutpoint_lower_pep" add_type="CUTPOINT_LOWER" residue_selector="select_pep_end" />
                <ModifyVariantType name="add_cutpoint_upper_loop" add_type="CUTPOINT_UPPER" residue_selector="select_loop_cutpoint_upper" />
                <ModifyVariantType name="add_cutpoint_lower_loop" add_type="CUTPOINT_LOWER" residue_selector="select_loop_cutpoint_lower" />

        <!-- Set up fold tree -->
        <AtomTree name="foldtree1" fold_tree_file="inputs/foldtree1.txt" />

        <!-- Perturb the anchor residue a bit -->
        <SetTorsion name="perturb_anchor" >
            <Torsion residue="234" torsion_name="phi" angle="perturb" perturbation_type="gaussian" perturbation_magnitude="5.0" />
            <Torsion residue="234" torsion_name="psi" angle="perturb" perturbation_type="gaussian" perturbation_magnitude="5.0" />
            <Torsion residue="pick_atoms" angle="perturb" perturbation_type="gaussian" perturbation_magnitude="5.0" >
                <Atom1 residue="234" atom="N" />
                <Atom2 residue="234" atom="CA" />
                <Atom3 residue="234" atom="CB" />
                <Atom4 residue="234" atom="CG" />
            </Torsion>
        </SetTorsion>

        <!-- Perturb the peptide -->
        <GeneralizedKIC name="genkic_pep" pre_selection_mover="cyclization_bond" closure_attempts="1000" correct_polymer_dependent_atoms="true" stop_when_n_solutions_found="20" selector="lowest_rmsd_selector" >
            <AddResidue res_index="235" />
            <AddResidue res_index="236" />
            <AddResidue res_index="237" />
            <AddResidue res_index="230" />
            <AddResidue res_index="231" />
            <AddResidue res_index="232" />
            <AddResidue res_index="233" />
            <SetPivots res1="235" res2="231" res3="233" atom1="CA" atom2="CA" atom3="CA" />
            <CloseBond atom1="C" atom2="N" res1="237" res2="230" bondlength="1.328685" angle1="116.199993" angle2="121.699997" torsion="180" />
            <AddPerturber effect="perturb_dihedral" >
                <AddAtoms res1="235" res2="235" atom1="N" atom2="CA" />
                <AddAtoms res1="236" res2="236" atom1="N" atom2="CA" />
                <AddAtoms res1="237" res2="237" atom1="N" atom2="CA" />
                <AddAtoms res1="230" res2="230" atom1="N" atom2="CA" />
                <AddAtoms res1="231" res2="231" atom1="N" atom2="CA" />
                <AddAtoms res1="232" res2="232" atom1="N" atom2="CA" />
                <AddAtoms res1="233" res2="233" atom1="N" atom2="CA" />

                <AddAtoms res1="235" res2="235" atom1="CA" atom2="C" />
                <AddAtoms res1="236" res2="236" atom1="CA" atom2="C" />
                <AddAtoms res1="237" res2="237" atom1="CA" atom2="C" />
                <AddAtoms res1="230" res2="230" atom1="CA" atom2="C" />
                <AddAtoms res1="231" res2="231" atom1="CA" atom2="C" />
                <AddAtoms res1="232" res2="232" atom1="CA" atom2="C" />
                <AddAtoms res1="233" res2="233" atom1="CA" atom2="C" />

                <AddValue value="5.0" />
            </AddPerturber>
            <AddFilter type="loop_bump_check" />
        </GeneralizedKIC>


        <!-- Perturb the loop -->
        <GeneralizedKIC name="genkic_loop" pre_selection_mover="loop_bond" closure_attempts="1000" correct_polymer_dependent_atoms="true" stop_when_n_solutions_found="20" selector="lowest_rmsd_selector" >
            <AddResidue res_index="23" />
            <AddResidue res_index="24" />
            <AddResidue res_index="25" />
            <AddResidue res_index="26" />
            <AddResidue res_index="27" />
            <AddResidue res_index="28" />
            <AddResidue res_index="29" />
            <AddResidue res_index="30" />
            <AddResidue res_index="31" />
            <AddResidue res_index="32" />
            <AddResidue res_index="33" />
            <SetPivots res1="23" res2="28" res3="33" atom1="CA" atom2="CA" atom3="CA" />
            <CloseBond atom1="C" atom2="N" res1="28" res2="29" bondlength="1.328685" angle1="116.199993" angle2="121.699997" torsion="180" />
            <AddPerturber effect="perturb_dihedral" >
                <AddAtoms res1="23" res2="23" atom1="N" atom2="CA" />
                <AddAtoms res1="24" res2="24" atom1="N" atom2="CA" />
                <AddAtoms res1="25" res2="25" atom1="N" atom2="CA" />
                <AddAtoms res1="26" res2="26" atom1="N" atom2="CA" />
                <AddAtoms res1="27" res2="27" atom1="N" atom2="CA" />
                <AddAtoms res1="28" res2="28" atom1="N" atom2="CA" />
                <AddAtoms res1="29" res2="29" atom1="N" atom2="CA" />
                <AddAtoms res1="30" res2="30" atom1="N" atom2="CA" />
                <AddAtoms res1="31" res2="31" atom1="N" atom2="CA" />
                <AddAtoms res1="32" res2="32" atom1="N" atom2="CA" />
                <AddAtoms res1="33" res2="33" atom1="N" atom2="CA" />

                <AddAtoms res1="23" res2="23" atom1="CA" atom2="C" />
                <AddAtoms res1="24" res2="24" atom1="CA" atom2="C" />
                <AddAtoms res1="25" res2="25" atom1="CA" atom2="C" />
                <AddAtoms res1="26" res2="26" atom1="CA" atom2="C" />
                <AddAtoms res1="27" res2="27" atom1="CA" atom2="C" />
                <AddAtoms res1="28" res2="28" atom1="CA" atom2="C" />
                <AddAtoms res1="29" res2="29" atom1="CA" atom2="C" />
                <AddAtoms res1="30" res2="30" atom1="CA" atom2="C" />
                <AddAtoms res1="31" res2="31" atom1="CA" atom2="C" />
                <AddAtoms res1="32" res2="32" atom1="CA" atom2="C" />
                <AddAtoms res1="33" res2="33" atom1="CA" atom2="C" />

                <AddValue value="3.0" />
            </AddPerturber>
            <AddFilter type="loop_bump_check" />
        </GeneralizedKIC>

        <!-- Add the amino acid composition constraints -->
        <AddCompositionConstraintMover name="add_comp" filename="inputs/design.comp" selector="select_pep" />

        <!-- Actually do the design -->
        <FastDesign name="fdes1" packer_palette="packer_palette" repeats="3" relaxscript="InterfaceDesign2019" scorefxn="r15_design" task_operations="only_repack_pro235,init_from_commandline,extrarot,no_cys_gly_met,no_pack_anchor,only_l_at_neg_phi,only_d_at_pos_phi,only_pack_near_pep,only_design_pep" movemap_factory="mm_factory" />
        <FastDesign name="fdes2" packer_palette="packer_palette" repeats="3" relaxscript="InterfaceDesign2019" scorefxn="r15_design2" task_operations="only_repack_pro235,init_from_commandline,extrarot,no_cys_gly_met,no_pack_anchor,only_l_at_neg_phi,only_d_at_pos_phi,only_pack_near_pep,only_design_pep" movemap_factory="mm_factory" />

        <!-- Store the amino acid sequence at the end for output in the PDB file -->
        <RunSimpleMetrics name="run_metrics" metrics="capture_sequence" prefix="SEQ_" />
    </MOVERS>
    <PROTOCOLS>
        <Add mover="cyclization_bond" />
        <Add mover="foldtree1" />
        <Add mover="add_cutpoint_upper_pep" />
        <Add mover="add_cutpoint_lower_pep" />
        <Add mover="add_cutpoint_upper_loop" />
        <Add mover="add_cutpoint_lower_loop" />
        <Add mover="perturb_anchor" />
        <Add mover="genkic_pep" />
        <Add mover="genkic_loop" />
        <Add mover="add_comp" />
        <Add mover="fdes1" />
        <Add mover="fdes2" />
        <Add mover="run_metrics" />
        <Add filter="shape_complementarity" />
        <Add filter="ddg" />
    </PROTOCOLS>
    <OUTPUT />
</ROSETTASCRIPTS>
